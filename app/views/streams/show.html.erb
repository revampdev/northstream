<div id="stream-media" class="hidden">
  <% if current_user && current_user.admin? %>
    <div class="container flex px-4 mx-auto my-8">
      <p> Stream Status: <code><%= @stream.status %> </code> | Stream Key: <code> <%= @stream.stream_key %></code> | RTMP Link: <code><%= @stream.stream_rtmp_link %></code> | Playback ID: <code><%= @stream.playback_id %></code></p>
      <% if current_account_admin? %>
        <%= link_to 'Edit Stream', edit_stream_path(@stream) %>
        <%= link_to 'Add Products', new_product_path({stream: @stream.id}) %>
      <% end %>
    </div>
  <% end %>
  <% if @admissible %>
    <div class="container px-4 mx-auto ">
      <div class="plyr__video-embed" id="video" data-playback="<%= @stream.playback_id %>">
        <video controls crossorigin playsinline poster="<%= url_for(@stream.stream_image) %>"></video>
      </div>
    </div>
  <% end %>
  <% if @stream.stream_image && !@admissible %>
    <div class="container px-4 mx-auto my-8">
      <div class="aspect-w-16 aspect-h-10">
        <%= image_tag(@stream.stream_image, height: '620px', width: '900px')%>
      </div>
    </div>
  <% end %>
</div>
<div class="container mx-auto">
  <div class="flex items-center justify-between my-6">
    <h1 class="h3"><%= @stream.name %></h1>
    <div class="">
      <% if current_user && !current_user.personal_account.card_type? %>
        <%= link_to 'Update Payment Method', subscription_path, class: 'btn btn-primary' %>
      <% elsif !current_user %>
        <%= link_to 'Create Account', new_user_registration_path(:stream_id => "#{@stream.id}"), class: 'btn btn-primary'%>
        <span>or</span>
        <%= link_to 'Login', new_user_session_path, class: 'btn btn-primary'%>
      <% elsif @admissible %>
        <p class="text-lg font-semibold">Hi <%= current_user.first_name %>! Enjoy the show.</p>
        <% unless @stream.products.nil? %>
          <% @stream.products.each do |product| %>
            <%= product.name %>
          <% end %>
        <% end %>
      <% else %>
        <%= render "tickets/form", ticket: @ticket, stream: @stream.id, price: @stream.price %>
      <% end %>
    </div>
    <%# <%= link_to t("edit"), edit_stream_path(@stream), class: "btn btn-link" %>
  </div>
  <div class="p-8 bg-white rounded shadow">
    <h4 class="h4">Description:</h4>
    <div class="mx-auto">
      <%= @stream.body %>
    </div>
  </div>
  <%# <%= link_to 'Purchase Ticket', new_ticket_path, stream: @stream, amount: @stream.price %>
</div>
</div>
<% if @admissible %>
  <script>
    document.addEventListener('turbo:load', () => {
      const videoContainer = document.querySelector('#video')
      const playback = videoContainer.dataset.playback
    	const source = `https://stream.mux.com/${playback}.m3u8`;
    	const video = document.querySelector('video');
      const container = document.querySelector('#stream-media')
    
    	// For more options see: https://github.com/sampotts/plyr/#options
    	// captions.update is required for captions to work with hls.js
    	const player = new Plyr(video, {captions: {active: true, update: true, language: 'en'}});
    	if (!Hls.isSupported()) {
    		video.src = source;
    	} else {
    		// For more Hls.js options, see https://github.com/dailymotion/hls.js
    		const hls = new Hls();
    		hls.loadSource(source);
    		hls.attachMedia(video);
    		window.hls = hls;
        setTimeout(() => container.classList.toggle('hidden'), 500)
    		// Handle changing captions
    		// player.on('languagechange', () => {
    		// 	// Caption support is still flaky. See: https://github.com/sampotts/plyr/issues/994
    		// 	setTimeout(() => hls.subtitleTrack = player.currentTrack, 500);
    		// });
    
    	}
    
    	// Expose player so it can be used from the console
    	// window.player = player;
    });
  </script>
<% end %>
